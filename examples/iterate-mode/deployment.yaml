# Production Deployment Example
#
# Multi-stage deployment workflow demonstrating reduced-parallelism
# and aggressive-timeout strategies for reliable production deployments

name: production-deployment
description: Deploy application to production with health checks and rollback capability
version: 1.0.0

# Configuration
config:
  environment: production
  region: us-east-1
  replicas: 3
  healthCheckTimeout: 60000
  rollbackOnFailure: true

# Workflow steps
steps:
  # Stage 1: Pre-deployment validation
  - name: validate-deployment-config
    description: Validate deployment configuration and prerequisites
    provider: claude
    prompt: |
      Validate deployment configuration for production environment:

      Checks:
      1. Docker image exists and is tagged correctly
      2. Kubernetes namespace exists
      3. ConfigMaps and Secrets are present
      4. Resource quotas are sufficient
      5. Previous deployment is stable

      Return validation report with pass/fail status
    timeout: 30000
    required: true
    retryable: true

  # Stage 2: Database migrations
  - name: run-database-migrations
    description: Apply pending database schema migrations
    provider: claude
    prompt: |
      Run database migrations for production database:

      Process:
      1. Connect to production database (read-only first to validate)
      2. Check migration status (get pending migrations)
      3. Create backup point
      4. Apply migrations in transaction
      5. Verify schema changes
      6. Run post-migration validation

      Return migration summary: applied, skipped, failed
    timeout: 120000  # 2 minutes for migrations
    required: true
    retryable: false  # Migrations are not idempotent
    dependsOn: [validate-deployment-config]

  # Stage 3: Deploy to staging for smoke tests
  - name: deploy-to-staging
    description: Deploy to staging environment first
    provider: claude
    prompt: |
      Deploy application to staging environment:

      Steps:
      1. Update deployment manifest with new image
      2. Apply Kubernetes manifests to staging namespace
      3. Wait for pods to be ready (max 5 minutes)
      4. Run smoke tests
      5. Check logs for errors

      Return deployment status and smoke test results
    timeout: 300000  # 5 minutes
    required: true
    retryable: true
    dependsOn: [run-database-migrations]

  # Stage 4: Deploy to production (rolling update)
  - name: deploy-to-production
    description: Rolling deployment to production with zero downtime
    provider: claude
    prompt: |
      Deploy to production using rolling update strategy:

      Strategy:
      1. Update 1 replica at a time
      2. Wait for health checks to pass
      3. Proceed to next replica
      4. Monitor error rates during rollout
      5. Pause if error rate > 1%

      Return deployment progress and health status
    timeout: 600000  # 10 minutes for gradual rollout
    required: true
    retryable: true
    dependsOn: [deploy-to-staging]

  # Stage 5: Run health checks
  - name: verify-production-health
    description: Comprehensive health check of production deployment
    provider: claude
    prompt: |
      Run comprehensive health checks on production:

      Checks:
      1. HTTP health endpoint returns 200 on all replicas
      2. Database connections are healthy
      3. External API integrations work
      4. Cache layer is responsive
      5. Message queue is processing
      6. Metrics are being reported

      Return health check results with pass/fail for each check
    timeout: 90000  # 90 seconds for thorough checks
    required: true
    retryable: true
    dependsOn: [deploy-to-production]

  # Stage 6: Run integration tests
  - name: run-integration-tests
    description: Run integration test suite against production
    provider: claude
    prompt: |
      Run integration tests against production deployment:

      Test suites:
      1. API endpoint tests (CRUD operations)
      2. Authentication/authorization tests
      3. Data consistency tests
      4. Performance tests (latency, throughput)
      5. Error handling tests

      Return test results: total, passed, failed, skipped
    timeout: 180000  # 3 minutes for test suite
    required: true
    retryable: true
    dependsOn: [verify-production-health]

  # Stage 7: Update DNS/load balancer
  - name: update-load-balancer
    description: Point load balancer to new deployment
    provider: claude
    prompt: |
      Update load balancer configuration:

      Steps:
      1. Get current load balancer targets
      2. Add new deployment targets
      3. Gradually shift traffic (10%, 25%, 50%, 100%)
      4. Monitor error rates at each stage
      5. Remove old targets after 100% traffic shift

      Return traffic shift progress and error rates
    timeout: 300000  # 5 minutes for gradual traffic shift
    required: true
    retryable: true
    dependsOn: [run-integration-tests]

  # Stage 8: Monitor for stability period
  - name: monitor-stability-period
    description: Monitor deployment for 5 minutes to ensure stability
    provider: claude
    prompt: |
      Monitor production deployment for stability:

      Monitor (5 minute window):
      1. Error rate < 0.1%
      2. Response time P95 < 200ms
      3. CPU usage < 80%
      4. Memory usage < 80%
      5. No pod restarts

      Return stability report with metrics
    timeout: 360000  # 6 minutes (5 min monitor + 1 min buffer)
    required: true
    retryable: true
    dependsOn: [update-load-balancer]

  # Stage 9: Send deployment notification
  - name: notify-deployment-success
    description: Notify team of successful deployment
    provider: claude
    prompt: |
      Send deployment success notification:

      Channels:
      - Slack #deployments channel
      - PagerDuty resolve incident (if any)
      - Update status page

      Include:
      - Deployment version
      - Duration
      - Health check results
      - Comparison to previous version (if available)
    timeout: 15000
    required: false  # Optional notification
    retryable: true
    dependsOn: [monitor-stability-period]

  # Stage 10: Archive deployment artifacts
  - name: archive-deployment-artifacts
    description: Archive deployment logs and artifacts
    provider: claude
    prompt: |
      Archive deployment artifacts to S3:

      Artifacts:
      1. Deployment manifest
      2. Migration logs
      3. Health check results
      4. Integration test results
      5. Monitoring snapshots

      Upload to: s3://deployments/prod/{version}/{timestamp}/
    timeout: 30000
    required: false  # Optional archival
    retryable: true
    dependsOn: [monitor-stability-period]

# Rollback configuration
rollback:
  enabled: true
  trigger: on_failure
  strategy: immediate
  steps:
    - name: rollback-deployment
      description: Rollback to previous stable version
      prompt: |
        Rollback production deployment:

        Steps:
        1. Get previous stable version from deployment history
        2. Update Kubernetes deployment to previous version
        3. Wait for pods to be ready
        4. Verify health checks pass
        5. Restore load balancer to previous targets

        Return rollback status

# Error handling
errorHandling:
  continueOnError: false
  capturePartialResults: true
  saveCheckpoints: true
  checkpointInterval: 3

# Monitoring
monitoring:
  logLevel: info
  metricsEnabled: true
  tracingEnabled: true
  alertOnFailure: true
  alertChannels:
    - slack
    - pagerduty

# Expected behavior with Iterate Mode:
#
# Iteration 1 (default strategy):
#   - All validation and deployment steps execute in parallel where possible
#   - May encounter resource exhaustion during parallel pod deployments
#   → Switches to reduced-parallelism strategy
#
# Iteration 2 (reduced-parallelism):
#   - Stages execute sequentially to avoid resource contention
#   - Health checks may timeout due to slow startup
#   → Switches to aggressive-timeout strategy
#
# Iteration 3 (aggressive-timeout + reduced-parallelism):
#   - Sequential execution with extended timeouts
#   - All stages complete successfully
#   → Deployment succeeds
#
# Total iterations: 3
# Expected duration: 15-20 minutes
# Expected cost: $1.50-2.50
#
# Safety recommendations:
# - Use --safety paranoid for production
# - Set --max-iterations 5 (limited retries)
# - Set --max-cost 5.0 (conservative budget)
