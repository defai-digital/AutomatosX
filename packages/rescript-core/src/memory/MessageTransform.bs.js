// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Js_dict from "rescript/lib/es6/js_dict.js";
import * as Js_json from "rescript/lib/es6/js_json.js";
import * as Timestamp from "./Timestamp.bs.js";
import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as HybridSearchTypes from "./HybridSearchTypes.bs.js";

function messageFromDb(row) {
  var roleOpt = HybridSearchTypes.parseMessageRole(row.role);
  if (roleOpt !== undefined) {
    return {
            id: row.id,
            conversationId: row.conversationId,
            role: roleOpt,
            content: row.content,
            tokens: Caml_option.nullable_to_opt(row.tokens),
            metadata: Caml_option.nullable_to_opt(row.metadata),
            createdAt: Timestamp.Seconds.fromInt(row.createdAt),
            updatedAt: Timestamp.Seconds.fromInt(row.updatedAt)
          };
  }
  
}

function vectorResultFromDb(row) {
  return {
          messageId: row.messageId,
          distance: row.distance,
          score: 1.0 - row.distance / 2.0
        };
}

function messagesFromDb(rows) {
  return Belt_Array.keepMap(rows, messageFromDb);
}

function vectorResultsFromDb(rows) {
  return Belt_Array.map(rows, vectorResultFromDb);
}

function messageToDb(msg) {
  return {
          id: msg.id,
          conversationId: msg.conversationId,
          role: HybridSearchTypes.messageRoleToString(msg.role),
          content: msg.content,
          tokens: Belt_Option.mapWithDefault(msg.tokens, undefined, (function (t) {
                  return t;
                })),
          metadata: Belt_Option.mapWithDefault(msg.metadata, undefined, (function (m) {
                  return m;
                })),
          createdAt: Timestamp.toDbInt(msg.createdAt),
          updatedAt: Timestamp.toDbInt(msg.updatedAt)
        };
}

function parseMetadata(jsonStr) {
  try {
    return JSON.parse(jsonStr);
  }
  catch (exn){
    return ;
  }
}

function stringifyMetadata(json) {
  return JSON.stringify(json);
}

function getStringField(json, field) {
  var obj = Js_json.decodeObject(json);
  if (obj === undefined) {
    return ;
  }
  var value = Js_dict.get(obj, field);
  if (value !== undefined) {
    return Js_json.decodeString(value);
  }
  
}

function getIntField(json, field) {
  var obj = Js_json.decodeObject(json);
  if (obj === undefined) {
    return ;
  }
  var value = Js_dict.get(obj, field);
  if (value === undefined) {
    return ;
  }
  var num = Js_json.decodeNumber(value);
  if (num !== undefined) {
    return num | 0;
  }
  
}

function validateMessage(msg) {
  if (msg.id !== "" && msg.conversationId !== "" && msg.content !== "" && Timestamp.isValidSeconds(msg.createdAt)) {
    return Timestamp.isValidSeconds(msg.updatedAt);
  } else {
    return false;
  }
}

function validateTimestamps(msg) {
  var createdSec = Timestamp.Seconds.toInt(msg.createdAt);
  var updatedSec = Timestamp.Seconds.toInt(msg.updatedAt);
  return createdSec <= updatedSec;
}

function isValidMessage(msg) {
  if (validateMessage(msg)) {
    return validateTimestamps(msg);
  } else {
    return false;
  }
}

function createMessage(id, conversationId, role, content, tokensOpt, metadataOpt, param) {
  var tokens = tokensOpt !== undefined ? Caml_option.valFromOption(tokensOpt) : undefined;
  var metadata = metadataOpt !== undefined ? Caml_option.valFromOption(metadataOpt) : undefined;
  var now = Timestamp.nowSeconds();
  return {
          id: id,
          conversationId: conversationId,
          role: role,
          content: content,
          tokens: tokens,
          metadata: metadata,
          createdAt: now,
          updatedAt: now
        };
}

function updateMessage(msg, contentOpt, tokensOpt, metadataOpt, param) {
  var content = contentOpt !== undefined ? Caml_option.valFromOption(contentOpt) : undefined;
  var tokens = tokensOpt !== undefined ? Caml_option.valFromOption(tokensOpt) : undefined;
  var metadata = metadataOpt !== undefined ? Caml_option.valFromOption(metadataOpt) : undefined;
  return {
          id: msg.id,
          conversationId: msg.conversationId,
          role: msg.role,
          content: Belt_Option.getWithDefault(content, msg.content),
          tokens: tokens !== undefined ? tokens : msg.tokens,
          metadata: metadata !== undefined ? metadata : msg.metadata,
          createdAt: msg.createdAt,
          updatedAt: Timestamp.nowSeconds()
        };
}

export {
  messageFromDb ,
  vectorResultFromDb ,
  messagesFromDb ,
  vectorResultsFromDb ,
  messageToDb ,
  parseMetadata ,
  stringifyMetadata ,
  getStringField ,
  getIntField ,
  validateMessage ,
  validateTimestamps ,
  isValidMessage ,
  createMessage ,
  updateMessage ,
}
/* No side effect */
