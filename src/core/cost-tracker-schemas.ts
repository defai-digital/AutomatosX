/**
 * Zod Schemas for Cost Tracking Runtime Validation
 *
 * Phase 1 (v8.5.6): Add runtime validation to prevent data corruption bugs
 *
 * Benefits:
 * - Validates cost entries before database insertion
 * - Prevents SQL injection via query parameter validation
 * - Better error messages with exact validation failures
 * - Type inference (no type duplication with types/cost.ts)
 *
 * @module core/cost-tracker-schemas
 */

import { z } from 'zod';

/**
 * Cost Entry Schema - validates cost data before database insertion
 *
 * Prevents corruption of financial data by ensuring:
 * - All required fields are present and valid types
 * - Token counts are non-negative integers
 * - Cost amounts are non-negative numbers
 * - Session IDs are valid UUIDs
 * - String lengths are within database column limits
 */
export const CostEntrySchema = z.object({
  // Auto-generated by database (optional for inserts)
  id: z.number().int().positive().optional(),

  // Required timestamp (Unix milliseconds)
  timestamp: z.number().int().nonnegative(),

  // Provider and model (required, max 100 chars for DB column)
  provider: z.string().min(1).max(100),
  model: z.string().min(1).max(100),

  // Token counts (non-negative integers)
  promptTokens: z.number().int().nonnegative(),
  completionTokens: z.number().int().nonnegative(),
  totalTokens: z.number().int().nonnegative(),

  // Cost in USD (non-negative, allows decimals)
  estimatedCostUsd: z.number().nonnegative(),

  // Optional fields
  sessionId: z.string().uuid().optional(),
  agent: z.string().min(1).max(100).optional(),
  requestId: z.string().max(200).optional()
}).strict(); // Reject unknown fields

/**
 * Cost Query Schema - validates query parameters before SQL execution
 *
 * Prevents SQL injection and invalid queries by ensuring:
 * - Session IDs are valid UUIDs
 * - Timestamps are non-negative integers
 * - Limits are positive and within bounds
 * - startTime <= endTime (cross-field validation)
 */
export const CostQuerySchema = z.object({
  // Filter fields (all optional)
  provider: z.string().optional(),
  model: z.string().optional(),
  sessionId: z.string().uuid().optional(),
  agent: z.string().min(1).max(100).optional(),

  // Time range filters (Unix milliseconds)
  startTime: z.number().int().nonnegative().optional(),
  endTime: z.number().int().nonnegative().optional(),

  // Result limit (max 10,000 to prevent memory exhaustion)
  limit: z.number().int().positive().max(10000).optional()
}).strict()
  .refine(
    (data) => {
      // Cross-field validation: startTime must be <= endTime
      if (data.startTime !== undefined && data.endTime !== undefined) {
        return data.startTime <= data.endTime;
      }
      return true;
    },
    {
      message: 'startTime must be <= endTime',
      path: ['startTime'] // Error will be attached to startTime field
    }
  );

/**
 * Type inference from schemas
 *
 * These types are identical to types/cost.ts but inferred from Zod schemas.
 * This eliminates type duplication and ensures runtime validation matches compile-time types.
 */
export type CostEntryValidated = z.infer<typeof CostEntrySchema>;
export type CostQueryValidated = z.infer<typeof CostQuerySchema>;

/**
 * Validation helper - validates cost entry with detailed error messages
 *
 * @param entry - Cost entry to validate
 * @returns Validated cost entry
 * @throws {z.ZodError} With detailed validation failures
 */
export function validateCostEntry(entry: unknown): CostEntryValidated {
  return CostEntrySchema.parse(entry);
}

/**
 * Validation helper - validates cost query with detailed error messages
 *
 * @param query - Cost query to validate
 * @returns Validated cost query
 * @throws {z.ZodError} With detailed validation failures
 */
export function validateCostQuery(query: unknown): CostQueryValidated {
  return CostQuerySchema.parse(query);
}

/**
 * Safe validation - returns validation result instead of throwing
 *
 * Useful for logging validation failures without crashing.
 *
 * @param entry - Cost entry to validate
 * @returns Success result or error details
 */
export function safeValidateCostEntry(entry: unknown) {
  return CostEntrySchema.safeParse(entry);
}

/**
 * Safe validation - returns validation result instead of throwing
 *
 * @param query - Cost query to validate
 * @returns Success result or error details
 */
export function safeValidateCostQuery(query: unknown) {
  return CostQuerySchema.safeParse(query);
}
