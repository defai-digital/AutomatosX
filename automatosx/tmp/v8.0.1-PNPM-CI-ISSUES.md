# v8.0.1 pnpm CI/CD Migration Issues

**Date**: 2025-11-15
**Status**: In Progress - Fixing artifact verification

## Summary

Successfully migrated from npm to pnpm but encountering artifact verification issues in CI.

## Issues Fixed

### ✅ 1. pnpm Version Conflict
**Error**: Multiple versions of pnpm specified
**Fix**: Removed `packageManager` field from package.json, kept version in workflow
**Commit**: `232c7540`

### ✅ 2. Outdated Lockfile
**Error**: ERR_PNPM_OUTDATED_LOCKFILE - workspace packages missing
**Fix**: Regenerated pnpm-lock.yaml with workspace dependencies using `pnpm install --no-frozen-lockfile`
**Commit**: `5381ca31`

### ✅ 3. Missing lru-cache Dependency
**Error**: TS2307: Cannot find module 'lru-cache'
**Fix**: Added `lru-cache@^11.2.2` to dependencies
**Commit**: `9009d2e9`

## Current Issue

###❌ 4. Build Artifact Verification Failure

**Error**:
```
runtime	Verify build artifacts exist: Process completed with exit code 1.
```

**Root Cause Analysis**:
The verification step checks for:
1. `dist/cli/index.js` ✅ (Created by TypeScript build)
2. `packages/rescript-core/lib/bs/src/Index.bs.js` ❓ (Need to verify path)

Both builds complete successfully:
- ReScript: "Finish compiling 1150 mseconds"
- TypeScript: Completes without errors

**Hypothesis**: The ReScript output path may have changed. The build compiles @rescript/core (217 files) which takes ~1.1 seconds, but our workspace package may output to a different location.

**Investigation Needed**:
1. Check actual ReScript output path in rescript.json
2. Verify lib/bs structure vs lib/js structure
3. Update verification step to check correct path

## Next Steps

1. Check rescript.json package-specs to determine output path
2. List actual build artifacts in packages/rescript-core/lib/
3. Update .github/workflows/runtime-ci.yml verification step
4. Test locally with same verification commands

## Files Modified

- `package.json` - Updated workspace scripts, engine requirements
- `pnpm-workspace.yaml` - Created for workspace configuration
- `pnpm-lock.yaml` - Generated with all dependencies
- `.github/workflows/runtime-ci.yml` - Migrated to pnpm
- `.github/workflows/sprint2-ci.yml` - Migrated to pnpm

## Performance Notes

- pnpm install: ~1 minute with caching
- ReScript build: ~1.1 seconds
- TypeScript build: ~10 seconds
- Total CI time: ~3-4 minutes (when passing)
