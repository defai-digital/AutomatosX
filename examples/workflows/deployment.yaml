# Deployment Workflow
# Automated deployment with health checks and rollback

name: deployment-workflow
description: CI/CD deployment workflow with testing, staging, and production
version: 1.0.0
author: AutomatosX
tags:
  - deployment
  - ci-cd
  - devops

config:
  timeout: 900000  # 15 minutes
  maxRetries: 2
  parallelism: 2
  continueOnError: false

steps:
  # Step 1: Run pre-deployment checks
  - key: pre-deployment-checks
    agent: devops
    prompt: |
      Run pre-deployment checks:

      Environment: {{environment}}
      Version: {{version}}

      Verify:
      1. Build artifacts exist
      2. All tests passed
      3. No blocking issues in tracking system
      4. Database migrations ready
      5. Required approvals obtained

      Return JSON with checksPassed (boolean) and details.
    dependencies: []
    parallel: false
    optional: false
    timeoutMs: 30000

  # Step 2: Deploy to staging (parallel with running tests)
  - key: deploy-staging
    agent: devops
    prompt: |
      Deploy to staging environment:

      Version: {{version}}
      Artifacts: {{artifacts}}

      Steps:
      1. Pull latest docker image
      2. Run database migrations
      3. Update service configuration
      4. Rolling deployment (zero downtime)
      5. Verify deployment health

      Return deployment summary with endpoints and status.
    dependencies:
      - pre-deployment-checks
    parallel: false
    optional: false
    timeoutMs: 300000
    retryPolicy:
      maxRetries: 2
      retryDelayMs: 10000
      retryBackoffMultiplier: 1.5

  # Step 3: Run integration tests on staging
  - key: staging-tests
    agent: quality
    prompt: |
      Run integration tests on staging:

      Staging Endpoints: {{deploy-staging.endpoints}}

      Test suites:
      - API integration tests
      - End-to-end tests
      - Performance tests
      - Security tests

      Return test results with pass/fail counts and details.
    dependencies:
      - deploy-staging
    parallel: false
    optional: false
    timeoutMs: 180000

  # Step 4: Health check staging
  - key: health-check-staging
    agent: devops
    prompt: |
      Perform health checks on staging:

      Endpoints: {{deploy-staging.endpoints}}

      Check:
      - Service uptime and responsiveness
      - Database connectivity
      - External API integrations
      - Memory and CPU usage
      - Error rates in logs

      Return health status (healthy/degraded/unhealthy) and metrics.
    dependencies:
      - deploy-staging
      - staging-tests
    parallel: false
    optional: false
    timeoutMs: 60000

  # Step 5: Production deployment (only if staging is healthy)
  - key: deploy-production
    agent: devops
    prompt: |
      Deploy to production environment:

      Version: {{version}}
      Staging Health: {{health-check-staging.status}}

      Deployment strategy: Blue-Green

      Steps:
      1. Deploy to green environment
      2. Run smoke tests
      3. Switch traffic gradually (10% → 50% → 100%)
      4. Monitor error rates
      5. Keep blue environment for rollback

      Return deployment summary and traffic routing status.
    dependencies:
      - health-check-staging
    parallel: false
    optional: false
    timeoutMs: 360000
    retryPolicy:
      maxRetries: 1
      retryDelayMs: 30000

  # Step 6: Monitor production health
  - key: monitor-production
    agent: devops
    prompt: |
      Monitor production deployment:

      Production Endpoints: {{deploy-production.endpoints}}

      Monitor for 5 minutes:
      - Response times (p50, p95, p99)
      - Error rates
      - CPU and memory usage
      - Database query performance
      - User traffic patterns

      Return monitoring summary and any alerts.
    dependencies:
      - deploy-production
    parallel: false
    optional: false
    timeoutMs: 360000

  # Step 7: Generate deployment report
  - key: generate-report
    agent: devops
    prompt: |
      Generate deployment report:

      Pre-checks: {{pre-deployment-checks}}
      Staging: {{deploy-staging}}
      Tests: {{staging-tests}}
      Production: {{deploy-production}}
      Monitoring: {{monitor-production}}

      Create report with:
      1. Deployment summary (version, duration, status)
      2. Test results
      3. Performance metrics (before/after)
      4. Health check results
      5. Rollback instructions (if needed)
      6. Next steps

      Return markdown formatted report.
    dependencies:
      - pre-deployment-checks
      - deploy-staging
      - staging-tests
      - deploy-production
      - monitor-production
    parallel: false
    optional: false
    timeoutMs: 30000
