# ğŸ§  AutomatosX v8.0.0 - Week 3-4 Day 4 Megathinking

**Date:** 2025-01-13
**Focus:** ScaffoldGenerator - Project Structure Generation from Workflows
**Scope:** Day 4 of Week 3-4 Spec-Kit Auto-Generation

---

## ğŸ¯ MISSION STATEMENT

**Goal:** Implement ScaffoldGenerator that creates complete project structures from workflow definitions, including:
- Directory hierarchy
- Configuration files
- Execution scripts
- Documentation (README, usage guides)
- CI/CD templates
- Test infrastructure setup

**Why It Matters:**
- **Productivity:** Auto-generate boilerplate saves 2-3 hours per project
- **Consistency:** Standardized project structure across all workflows
- **Best Practices:** Templates embed proven patterns (configs, scripts, docs)
- **Onboarding:** New users get complete, runnable projects instantly

**Success Criteria:**
- âœ… Generate directory structure from workflow
- âœ… Create config files (JSON, environment variables)
- âœ… Generate executable scripts (run.sh, deploy.sh, cleanup.sh)
- âœ… Generate documentation (README.md with usage instructions)
- âœ… Optional: CI/CD templates (.github/workflows, .gitlab-ci.yml)
- âœ… Optional: Test infrastructure (test directories, fixtures, mocks)
- âœ… CLI command: `ax gen scaffold <workflow.yaml>`
- âœ… >15 tests passing (structure, files, scripts, edge cases)

---

## ğŸ” REQUIREMENTS ANALYSIS

### Functional Requirements

**FR1: Directory Structure Generation**
- Input: WorkflowDefinition
- Output: Directory tree matching workflow complexity
- Base directories: `workflows/`, `configs/`, `scripts/`, `docs/`
- Optional directories: `tests/`, `fixtures/`, `.github/workflows/`, `logs/`, `outputs/`

**FR2: Configuration File Generation**
- Default config: `configs/default.config.json` with workflow-specific settings
- Environment template: `.env.example` with required variables
- Provider configs: `configs/providers.json` for API keys (with placeholders)
- Agent configs: `configs/agents.json` for agent-specific settings

**FR3: Script Generation**
- `scripts/run.sh`: Execute workflow with default config
- `scripts/run-with-config.sh`: Execute with custom config
- `scripts/validate.sh`: Validate workflow YAML
- `scripts/cleanup.sh`: Clean up outputs and logs
- `scripts/deploy.sh` (optional): Deploy workflow to production
- All scripts: executable permissions, error handling, colored output

**FR4: Documentation Generation**
- `README.md`: Project overview, setup, usage, examples
- `docs/USAGE.md`: Detailed usage guide
- `docs/CONFIGURATION.md`: Config file documentation
- `docs/TROUBLESHOOTING.md`: Common issues and solutions
- Inline workflow documentation in YAML comments

**FR5: CI/CD Template Generation**
- `.github/workflows/ci.yml`: GitHub Actions workflow
- `.gitlab-ci.yml`: GitLab CI/CD pipeline
- `Jenkinsfile`: Jenkins pipeline (optional)
- Test, lint, validate steps
- Auto-deploy on main branch

**FR6: Test Infrastructure Setup**
- `tests/` directory with subdirectories: `unit/`, `integration/`, `e2e/`
- Test fixtures: `fixtures/sample-inputs/`, `fixtures/expected-outputs/`
- Mock data: `mocks/providers.ts`, `mocks/agents.ts`
- Test config: `vitest.config.ts` or `jest.config.js`

**FR7: Template System**
- Template registry with named templates: 'minimal', 'standard', 'complete', 'enterprise'
- Variable substitution: `{{workflow.name}}`, `{{workflow.version}}`, `{{step.id}}`
- Conditional sections: `{{#if includeTests}}...{{/if}}`
- Loop sections: `{{#each steps}}...{{/each}}`
- Template inheritance and composition

**FR8: File Operations**
- Create directories recursively
- Write files with proper permissions
- Preserve existing files (no overwrites without confirmation)
- Dry-run mode: show what would be created without writing
- Verbose mode: show each file/directory created

### Non-Functional Requirements

**NFR1: Performance**
- Scaffold generation: <5 seconds for typical workflows (<50 steps)
- File I/O: async operations, no blocking
- Template rendering: <100ms per file

**NFR2: Usability**
- Clear console output with progress indicators
- Color-coded success/error messages
- Summary table showing created files
- Next steps suggestions

**NFR3: Reliability**
- Atomic operations: rollback on error
- Validation before writing files
- Handle file system errors gracefully
- Idempotent: can run multiple times safely

**NFR4: Maintainability**
- Clean separation: structure builder vs file writer vs template renderer
- Template-driven: easy to add new templates
- Well-tested: >80% coverage

---

## ğŸ—ï¸ ARCHITECTURE DESIGN

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ScaffoldGenerator                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ StructureBuilder â”‚â”€â”€â”€â”€â–¶â”‚  TemplateRenderer  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                         â”‚                â”‚
â”‚          â”‚                         â–¼                â”‚
â”‚          â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚          â”‚                 â”‚ TemplateRegistry   â”‚   â”‚
â”‚          â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FileWriter      â”‚â”€â”€â”€â”€â–¶â”‚  FileSystem        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                                          â”‚
â”‚          â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚  Validator       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Class Design

**ScaffoldGenerator (main)**
```typescript
export class ScaffoldGenerator {
  constructor(
    private structureBuilder: StructureBuilder,
    private templateRenderer: TemplateRenderer,
    private fileWriter: FileWriter,
    private validator: Validator
  ) {}

  async generateScaffold(
    workflow: WorkflowDefinition,
    options: ScaffoldOptions
  ): Promise<ScaffoldResult> {
    // 1. Validate workflow
    await this.validator.validate(workflow);

    // 2. Build structure
    const structure = await this.structureBuilder.build(workflow, options);

    // 3. Render templates
    const files = await this.templateRenderer.render(structure, workflow, options);

    // 4. Write files
    const result = await this.fileWriter.write(files, options);

    return result;
  }
}
```

**StructureBuilder**
```typescript
export class StructureBuilder {
  build(workflow: WorkflowDefinition, options: ScaffoldOptions): ProjectStructure {
    const directories = this.buildDirectories(workflow, options);
    const fileTemplates = this.buildFileTemplates(workflow, options);

    return { directories, fileTemplates };
  }

  private buildDirectories(workflow, options): string[] {
    const base = ['workflows', 'configs', 'scripts', 'docs'];

    if (options.includeTests) base.push('tests', 'tests/unit', 'tests/integration');
    if (options.includeCI) base.push('.github/workflows');
    if (options.includeLogs) base.push('logs');

    return base;
  }

  private buildFileTemplates(workflow, options): FileTemplate[] {
    return [
      { path: 'workflows/main.yaml', template: 'workflow.yaml.hbs' },
      { path: 'configs/default.json', template: 'config.json.hbs' },
      { path: 'scripts/run.sh', template: 'run.sh.hbs', executable: true },
      { path: 'README.md', template: 'readme.md.hbs' },
      // ... more templates
    ];
  }
}
```

**TemplateRenderer**
```typescript
export class TemplateRenderer {
  constructor(private registry: TemplateRegistry) {}

  async render(
    structure: ProjectStructure,
    workflow: WorkflowDefinition,
    options: ScaffoldOptions
  ): Promise<RenderedFile[]> {
    const context = this.buildContext(workflow, options);
    const files: RenderedFile[] = [];

    for (const fileTemplate of structure.fileTemplates) {
      const template = await this.registry.getTemplate(fileTemplate.template);
      const content = template(context); // Handlebars rendering
      files.push({
        path: fileTemplate.path,
        content,
        executable: fileTemplate.executable
      });
    }

    return files;
  }

  private buildContext(workflow, options): TemplateContext {
    return {
      workflow: {
        name: workflow.name,
        version: workflow.version,
        description: workflow.description,
        steps: workflow.steps,
        stepCount: workflow.steps.length
      },
      options: {
        includeTests: options.includeTests,
        includeCI: options.includeCI,
        includeDocs: options.includeDocs
      },
      timestamp: new Date().toISOString(),
      generator: 'AutomatosX v8.0.0'
    };
  }
}
```

**FileWriter**
```typescript
export class FileWriter {
  async write(
    files: RenderedFile[],
    options: ScaffoldOptions
  ): Promise<ScaffoldResult> {
    const outputPath = options.outputPath;
    const createdFiles: string[] = [];
    const createdDirectories: string[] = [];

    // Create directories
    for (const dir of structure.directories) {
      const fullPath = path.join(outputPath, dir);
      await fs.mkdir(fullPath, { recursive: true });
      createdDirectories.push(dir);
    }

    // Write files
    for (const file of files) {
      const fullPath = path.join(outputPath, file.path);

      // Check for existing file
      if (await this.fileExists(fullPath) && !options.overwrite) {
        if (options.interactive) {
          const shouldOverwrite = await this.promptOverwrite(file.path);
          if (!shouldOverwrite) continue;
        } else {
          throw new Error(`File exists: ${file.path}. Use --overwrite to replace.`);
        }
      }

      await fs.writeFile(fullPath, file.content, 'utf-8');

      if (file.executable) {
        await fs.chmod(fullPath, 0o755);
      }

      createdFiles.push(file.path);
    }

    return {
      outputPath,
      createdFiles,
      createdDirectories,
      summary: this.buildSummary(createdFiles, createdDirectories)
    };
  }
}
```

**TemplateRegistry**
```typescript
export class TemplateRegistry {
  private templates: Map<string, HandlebarsTemplateDelegate> = new Map();

  constructor() {
    this.registerDefaultTemplates();
  }

  private registerDefaultTemplates() {
    // Register built-in templates
    this.register('workflow.yaml.hbs', workflowTemplate);
    this.register('config.json.hbs', configTemplate);
    this.register('run.sh.hbs', runScriptTemplate);
    this.register('readme.md.hbs', readmeTemplate);
    // ... more
  }

  register(name: string, template: string | HandlebarsTemplateDelegate) {
    if (typeof template === 'string') {
      this.templates.set(name, Handlebars.compile(template));
    } else {
      this.templates.set(name, template);
    }
  }

  getTemplate(name: string): HandlebarsTemplateDelegate {
    const template = this.templates.get(name);
    if (!template) {
      throw new Error(`Template not found: ${name}`);
    }
    return template;
  }
}
```

---

## ğŸ“ TEMPLATE SPECIFICATIONS

### Template: `workflow.yaml.hbs`

```handlebars
# {{workflow.name}}
# Version: {{workflow.version}}
# Generated by {{generator}} on {{timestamp}}

name: "{{workflow.name}}"
version: "{{workflow.version}}"
description: "{{workflow.description}}"

steps:
{{#each workflow.steps}}
  - id: "{{this.id}}"
    name: "{{this.name}}"
    action: "{{this.action}}"
    config: {{json this.config}}
    {{#if this.dependsOn}}
    dependsOn: {{json this.dependsOn}}
    {{/if}}
    {{#if this.timeout}}
    timeout: {{this.timeout}}
    {{/if}}
    {{#if this.retry}}
    retry: {{json this.retry}}
    {{/if}}
{{/each}}
```

### Template: `config.json.hbs`

```handlebars
{
  "workflow": {
    "name": "{{workflow.name}}",
    "version": "{{workflow.version}}",
    "timeout": 600000,
    "retryPolicy": {
      "maxRetries": 3,
      "backoffMultiplier": 2,
      "initialDelay": 1000
    }
  },
  "providers": {
    "claude": {
      "model": "claude-3-5-sonnet-20241022",
      "maxTokens": 4096,
      "temperature": 0.7
    },
    "gemini": {
      "model": "gemini-2.0-flash-exp",
      "maxTokens": 8192,
      "temperature": 0.7
    }
  },
  "agents": {
{{#each workflow.steps}}
    "{{this.agent}}": {
      "enabled": true,
      "timeout": {{#if this.timeout}}{{this.timeout}}{{else}}60000{{/if}}
    }{{#unless @last}},{{/unless}}
{{/each}}
  },
  "outputs": {
    "directory": "./outputs",
    "format": "json",
    "includeTimestamp": true
  },
  "logging": {
    "level": "info",
    "directory": "./logs",
    "maxFiles": 10,
    "maxSize": "10m"
  }
}
```

### Template: `run.sh.hbs`

```handlebars
#!/bin/bash
# {{workflow.name}} - Execution Script
# Generated by {{generator}}

set -e  # Exit on error
set -u  # Error on undefined variables

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Default config
CONFIG_FILE="${PROJECT_DIR}/configs/default.json"

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -c|--config)
      CONFIG_FILE="$2"
      shift 2
      ;;
    -v|--verbose)
      VERBOSE=true
      shift
      ;;
    -h|--help)
      echo "Usage: $0 [OPTIONS]"
      echo "Options:"
      echo "  -c, --config <file>   Config file (default: configs/default.json)"
      echo "  -v, --verbose         Verbose output"
      echo "  -h, --help            Show this help"
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
  esac
done

# Validate config exists
if [ ! -f "$CONFIG_FILE" ]; then
  echo -e "${RED}Config file not found: $CONFIG_FILE${NC}"
  exit 1
fi

# Print header
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  {{workflow.name}}${NC}"
echo -e "${BLUE}  Version: {{workflow.version}}${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check dependencies
echo -e "${YELLOW}Checking dependencies...${NC}"
if ! command -v ax &> /dev/null; then
  echo -e "${RED}AutomatosX CLI not found. Install: npm install -g automatosx${NC}"
  exit 1
fi
echo -e "${GREEN}âœ“ Dependencies OK${NC}"
echo ""

# Run workflow
echo -e "${YELLOW}Running workflow...${NC}"
START_TIME=$(date +%s)

if [ "${VERBOSE:-false}" = true ]; then
  ax workflow run "${PROJECT_DIR}/workflows/main.yaml" \
    --config "$CONFIG_FILE" \
    --verbose
else
  ax workflow run "${PROJECT_DIR}/workflows/main.yaml" \
    --config "$CONFIG_FILE"
fi

EXIT_CODE=$?
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Print summary
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ $EXIT_CODE -eq 0 ]; then
  echo -e "${GREEN}âœ… Workflow completed successfully${NC}"
else
  echo -e "${RED}âŒ Workflow failed with exit code $EXIT_CODE${NC}"
fi
echo -e "${BLUE}  Duration: ${DURATION}s${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit $EXIT_CODE
```

### Template: `readme.md.hbs`

```handlebars
# {{workflow.name}}

{{workflow.description}}

**Version:** {{workflow.version}}
**Generated:** {{timestamp}}

---

## ğŸ“‹ Overview

This project contains an AutomatosX workflow with {{workflow.stepCount}} steps.

### Workflow Steps

{{#each workflow.steps}}
{{inc @index}}. **{{this.name}}** (`{{this.id}}`)
   - Action: `{{this.action}}`
   {{#if this.description}}
   - Description: {{this.description}}
   {{/if}}
   {{#if this.dependsOn}}
   - Dependencies: {{join this.dependsOn ", "}}
   {{/if}}
{{/each}}

---

## ğŸš€ Quick Start

### Prerequisites

- Node.js v18+
- AutomatosX CLI v8.0.0+

```bash
npm install -g automatosx
```

### Installation

1. Clone or download this project
2. Review configuration in `configs/default.json`
3. Update environment variables (if needed)

### Running the Workflow

**Basic execution:**
```bash
./scripts/run.sh
```

**With custom config:**
```bash
./scripts/run.sh --config configs/production.json
```

**Verbose mode:**
```bash
./scripts/run.sh --verbose
```

---

## âš™ï¸ Configuration

### Default Config (`configs/default.json`)

The default configuration includes:
- Provider settings (Claude, Gemini, OpenAI)
- Agent configurations
- Retry policies
- Output settings
- Logging configuration

### Environment Variables

Create a `.env` file with:
```bash
# API Keys
ANTHROPIC_API_KEY=your_key_here
GOOGLE_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here

# Optional
LOG_LEVEL=info
OUTPUT_DIR=./outputs
```

---

## ğŸ“ Project Structure

```
.
â”œâ”€â”€ workflows/           # Workflow definitions
â”‚   â””â”€â”€ main.yaml
â”œâ”€â”€ configs/            # Configuration files
â”‚   â””â”€â”€ default.json
â”œâ”€â”€ scripts/            # Execution scripts
â”‚   â”œâ”€â”€ run.sh
â”‚   â”œâ”€â”€ validate.sh
â”‚   â””â”€â”€ cleanup.sh
â”œâ”€â”€ docs/               # Documentation
â”‚   â””â”€â”€ USAGE.md
{{#if options.includeTests}}
â”œâ”€â”€ tests/              # Test suites
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ fixtures/
{{/if}}
{{#if options.includeCI}}
â”œâ”€â”€ .github/            # CI/CD workflows
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci.yml
{{/if}}
â”œâ”€â”€ logs/               # Execution logs
â”œâ”€â”€ outputs/            # Workflow outputs
â””â”€â”€ README.md           # This file
```

---

## ğŸ§ª Testing

{{#if options.includeTests}}
Run tests:
```bash
npm test
```

Run specific test suite:
```bash
npm test -- tests/integration/workflow.test.ts
```
{{else}}
Tests not included. Add `--include-tests` when scaffolding.
{{/if}}

---

## ğŸ”§ Maintenance

### Validate Workflow

```bash
./scripts/validate.sh
```

### Clean Up

```bash
./scripts/cleanup.sh
```

### View Logs

```bash
tail -f logs/latest.log
```

---

## ğŸ“š Documentation

- [Usage Guide](docs/USAGE.md)
- [Configuration Reference](docs/CONFIGURATION.md)
- [Troubleshooting](docs/TROUBLESHOOTING.md)
- [AutomatosX Documentation](https://docs.automatosx.dev)

---

## ğŸ“„ License

This workflow was generated by AutomatosX v8.0.0.

---

**Generated by AutomatosX Scaffold Generator**
**Date:** {{timestamp}}
```

---

## ğŸ¯ IMPLEMENTATION PLAN

### Phase 1: Core Infrastructure (2 hours)

**Step 1.1: Type Definitions**
- Add to `src/speckit/types/speckit.types.ts`:
  - `ScaffoldOptions` interface
  - `ScaffoldResult` interface
  - `ProjectStructure` interface
  - `FileTemplate` interface
  - `RenderedFile` interface
  - `TemplateContext` interface

**Step 1.2: TemplateRegistry**
- Create `src/speckit/utils/TemplateRegistry.ts`
- Implement Handlebars template registration
- Add built-in templates (workflow, config, scripts, readme)
- Add template helpers (json, join, inc)

**Step 1.3: StructureBuilder**
- Create `src/speckit/utils/StructureBuilder.ts`
- Implement directory structure building
- Implement file template mapping
- Support template variations (minimal, standard, complete)

### Phase 2: Template Rendering (1.5 hours)

**Step 2.1: TemplateRenderer**
- Create `src/speckit/utils/TemplateRenderer.ts`
- Implement context building from workflow
- Implement template rendering with Handlebars
- Handle template errors gracefully

**Step 2.2: Built-in Templates**
- Implement `workflow.yaml.hbs`
- Implement `config.json.hbs`
- Implement `run.sh.hbs`
- Implement `readme.md.hbs`
- Implement `validate.sh.hbs`
- Implement `cleanup.sh.hbs`

### Phase 3: File Operations (1 hour)

**Step 3.1: FileWriter**
- Create `src/speckit/utils/FileWriter.ts`
- Implement directory creation (recursive)
- Implement file writing with permission handling
- Implement overwrite protection and prompts
- Implement dry-run mode

**Step 3.2: Validator**
- Create `src/speckit/utils/ScaffoldValidator.ts`
- Validate workflow structure
- Validate output path (writable, not system directory)
- Validate template references

### Phase 4: ScaffoldGenerator (1 hour)

**Step 4.1: Main Generator**
- Create `src/speckit/generators/ScaffoldGenerator.ts`
- Implement `generateScaffold()` orchestration
- Wire up: StructureBuilder â†’ TemplateRenderer â†’ FileWriter
- Implement error handling and rollback

**Step 4.2: Advanced Features**
- Implement CI/CD template generation (.github/workflows/ci.yml)
- Implement test infrastructure setup
- Implement .gitignore generation
- Implement package.json generation (optional)

### Phase 5: CLI Integration (0.5 hours)

**Step 5.1: Command**
- Add `createScaffoldCommand()` to `src/cli/commands/gen.ts`
- Options: --output, --template, --include-tests, --include-ci, --overwrite, --dry-run
- Rich console output with file tree visualization
- Progress indicators

**Step 5.2: Output Formatting**
- File tree visualization (â”œâ”€â”€ â””â”€â”€ characters)
- Color-coded file types (scripts green, configs blue, docs cyan)
- Summary table (files created, directories created, total size)

### Phase 6: Testing (2 hours)

**Step 6.1: Unit Tests**
- Create `src/speckit/__tests__/ScaffoldGenerator.test.ts`
- Test StructureBuilder: directory/file lists
- Test TemplateRenderer: context building, rendering
- Test FileWriter: file creation, permissions, overwrite protection
- Test ScaffoldGenerator: end-to-end generation

**Step 6.2: Integration Tests**
- Test with minimal workflow (1 step)
- Test with complex workflow (10+ steps, parallel execution)
- Test with all options enabled
- Test dry-run mode
- Test overwrite scenarios

**Step 6.3: Edge Cases**
- Empty workflow
- Workflow with no config
- Invalid output path
- Missing templates
- File system errors

---

## ğŸ“Š FILE STRUCTURE

### New Files (9 total)

1. `src/speckit/generators/ScaffoldGenerator.ts` (~500 lines)
2. `src/speckit/utils/TemplateRegistry.ts` (~200 lines)
3. `src/speckit/utils/StructureBuilder.ts` (~250 lines)
4. `src/speckit/utils/TemplateRenderer.ts` (~150 lines)
5. `src/speckit/utils/FileWriter.ts` (~200 lines)
6. `src/speckit/utils/ScaffoldValidator.ts` (~100 lines)
7. `src/speckit/templates/` (directory with .hbs files)
8. `src/speckit/__tests__/ScaffoldGenerator.test.ts` (~600 lines)
9. Updates to `src/cli/commands/gen.ts` (~150 lines added)

### Modified Files (1 total)

1. `src/speckit/types/speckit.types.ts` (add ScaffoldOptions, ScaffoldResult, etc.)

**Total Lines:** ~2,150 new lines

---

## âœ… TESTING STRATEGY

### Test Categories

**Unit Tests (12 tests):**
1. StructureBuilder: builds correct directory list
2. StructureBuilder: builds correct file list
3. TemplateRegistry: registers and retrieves templates
4. TemplateRenderer: renders workflow template
5. TemplateRenderer: renders config template
6. TemplateRenderer: renders script templates
7. FileWriter: creates directories
8. FileWriter: writes files with correct content
9. FileWriter: sets executable permissions
10. FileWriter: prevents overwrite without flag
11. Validator: validates workflow
12. Validator: validates output path

**Integration Tests (8 tests):**
13. ScaffoldGenerator: generates minimal scaffold
14. ScaffoldGenerator: generates standard scaffold
15. ScaffoldGenerator: generates complete scaffold with tests
16. ScaffoldGenerator: generates with CI/CD templates
17. ScaffoldGenerator: handles existing files
18. ScaffoldGenerator: dry-run mode works
19. ScaffoldGenerator: generates valid scripts (executable)
20. ScaffoldGenerator: generates valid YAML workflow

**Total Tests:** 20

---

## ğŸ¨ CLI OUTPUT DESIGN

### Console Output Example

```
$ ax gen scaffold workflows/security-audit.yaml --output ./audit-project --include-tests --include-ci

âœ“ Loaded workflow: Security Audit (v1.0.0)
âœ“ Building project structure...
âœ“ Rendering templates...
âœ“ Writing files...

ğŸ“¦ Created Project Structure:

./audit-project/
â”œâ”€â”€ ğŸ“‚ workflows/
â”‚   â””â”€â”€ ğŸ“„ main.yaml (12.3 KB)
â”œâ”€â”€ ğŸ“‚ configs/
â”‚   â”œâ”€â”€ ğŸ“„ default.json (2.1 KB)
â”‚   â””â”€â”€ ğŸ“„ .env.example (456 B)
â”œâ”€â”€ ğŸ“‚ scripts/
â”‚   â”œâ”€â”€ ğŸ”§ run.sh (1.8 KB)
â”‚   â”œâ”€â”€ ğŸ”§ validate.sh (892 B)
â”‚   â””â”€â”€ ğŸ”§ cleanup.sh (654 B)
â”œâ”€â”€ ğŸ“‚ docs/
â”‚   â”œâ”€â”€ ğŸ“„ README.md (4.2 KB)
â”‚   â”œâ”€â”€ ğŸ“„ USAGE.md (3.1 KB)
â”‚   â””â”€â”€ ğŸ“„ TROUBLESHOOTING.md (1.9 KB)
â”œâ”€â”€ ğŸ“‚ tests/
â”‚   â”œâ”€â”€ ğŸ“‚ unit/
â”‚   â”œâ”€â”€ ğŸ“‚ integration/
â”‚   â””â”€â”€ ğŸ“‚ fixtures/
â”œâ”€â”€ ğŸ“‚ .github/
â”‚   â””â”€â”€ ğŸ“‚ workflows/
â”‚       â””â”€â”€ ğŸ“„ ci.yml (1.2 KB)
â”œâ”€â”€ ğŸ“‚ logs/
â”œâ”€â”€ ğŸ“‚ outputs/
â”œâ”€â”€ ğŸ“„ .gitignore (234 B)
â””â”€â”€ ğŸ“„ README.md (5.6 KB)

âœ… Scaffold Generated Successfully!

ğŸ“Š Summary:
   Files Created: 14
   Directories Created: 11
   Total Size: 34.2 KB
   Output Path: ./audit-project

ğŸ’¡ Next Steps:
   1. Review: ./audit-project/README.md
   2. Configure: Edit ./audit-project/configs/default.json
   3. Run: cd audit-project && ./scripts/run.sh
   4. Test: npm test (if tests included)
```

---

## ğŸš¨ RISK ANALYSIS

### Risk 1: Template Complexity

**Probability:** Medium
**Impact:** Medium

**Mitigation:**
- Keep templates simple and readable
- Use Handlebars (proven, widely-used)
- Provide template override mechanism
- Extensive template testing

### Risk 2: File System Errors

**Probability:** Low
**Impact:** High

**Mitigation:**
- Validate output path before writing
- Atomic operations with rollback
- Clear error messages with recovery steps
- Dry-run mode for preview

### Risk 3: Template Variable Errors

**Probability:** Medium
**Impact:** Low

**Mitigation:**
- Validate context before rendering
- Provide default values for all variables
- Template compilation validation at startup
- Helpful error messages pointing to template line

### Risk 4: Platform Compatibility (Scripts)

**Probability:** Low
**Impact:** Medium

**Mitigation:**
- Use bash (widely available)
- Provide .bat/.ps1 alternatives for Windows
- Document platform requirements
- Detect OS and generate appropriate scripts

---

## ğŸ“ˆ SUCCESS METRICS

**Quantitative:**
- âœ… >20 tests passing (100% pass rate)
- âœ… Scaffold generation <5 seconds
- âœ… Generated projects run successfully (100%)
- âœ… File tree depth â‰¤ 4 levels
- âœ… Template rendering <100ms per file

**Qualitative:**
- âœ… Clear, intuitive file organization
- âœ… Generated scripts work without modification
- âœ… Documentation is complete and helpful
- âœ… CI/CD templates are production-ready

---

## ğŸ¯ COMPLETION CRITERIA

**Code:**
- âœ… ScaffoldGenerator implemented and tested
- âœ… All utility classes complete (StructureBuilder, TemplateRenderer, FileWriter)
- âœ… Templates for all file types
- âœ… CLI command integrated

**Testing:**
- âœ… 20/20 tests passing
- âœ… Edge cases covered
- âœ… Integration tests verify end-to-end flow

**Documentation:**
- âœ… Code comments and JSDoc
- âœ… README with usage examples
- âœ… Completion document (v8.0.0-WEEK3-DAY4-COMPLETE.md)

**Integration:**
- âœ… `ax gen scaffold` command works
- âœ… Generated projects are runnable
- âœ… All file permissions correct

---

## ğŸš€ DEPENDENCIES

**NPM Packages (existing):**
- `handlebars` - Template engine
- `fs/promises` - Async file operations
- `path` - Path manipulation
- `chalk` - Console colors
- `ora` - Spinners
- `commander` - CLI framework

**NPM Packages (new):**
- None required (all dependencies already installed)

**Internal Dependencies:**
- `WorkflowParser` - Parse workflow YAML
- `DependencyGraph` - For CI/CD workflow step ordering
- `WorkflowDefinition` type

---

## ğŸ’¡ INNOVATION OPPORTUNITIES

**Future Enhancements:**

1. **Template Marketplace:**
   - Community-contributed templates
   - Template ratings and reviews
   - Template versioning

2. **Smart Scaffolding:**
   - Detect project type (microservice, CLI, web app)
   - Auto-generate appropriate structure
   - Language-specific templates (Node.js, Python, Go)

3. **Interactive Mode:**
   - Step-by-step wizard
   - Template customization prompts
   - Preview before generation

4. **Git Integration:**
   - Auto-initialize git repository
   - Create initial commit
   - Generate .gitignore from template

5. **Docker Support:**
   - Generate Dockerfile
   - Generate docker-compose.yml
   - Container-based execution scripts

---

## âœ… MEGATHINKING SUMMARY

**Estimated Effort:** 8 hours
- Core Infrastructure: 2 hours
- Template Rendering: 1.5 hours
- File Operations: 1 hour
- ScaffoldGenerator: 1 hour
- CLI Integration: 0.5 hours
- Testing: 2 hours

**Confidence Level:** 90%

**Key Success Factors:**
1. Simple, maintainable template system
2. Robust file operations with error handling
3. Comprehensive testing (20 tests)
4. Clear, helpful console output
5. Well-documented generated projects

**Ready to Implement:** âœ…

---

**Megathinking Complete**
**Date:** 2025-01-13
**Status:** Ready for Day 4 Implementation
