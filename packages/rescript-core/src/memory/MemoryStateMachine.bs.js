// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Js_dict from "rescript/lib/es6/js_dict.js";
import * as Js_json from "rescript/lib/es6/js_json.js";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";

function toString(state) {
  switch (state) {
    case "Idle" :
        return "idle";
    case "Active" :
        return "active";
    case "Searching" :
        return "searching";
    case "Archived" :
        return "archived";
    case "Deleted" :
        return "deleted";
    
  }
}

function fromString(str) {
  switch (str) {
    case "active" :
        return "Active";
    case "archived" :
        return "Archived";
    case "deleted" :
        return "Deleted";
    case "idle" :
        return "Idle";
    case "searching" :
        return "Searching";
    default:
      return ;
  }
}

function isTerminal(state) {
  if (state === "Deleted") {
    return true;
  } else {
    return false;
  }
}

var State = {
  toString: toString,
  fromString: fromString,
  isTerminal: isTerminal
};

function toString$1($$event) {
  if (typeof $$event !== "object") {
    switch ($$event) {
      case "ArchiveConversation" :
          return "archive_conversation";
      case "DeleteConversation" :
          return "delete_conversation";
      case "RestoreConversation" :
          return "restore_conversation";
      
    }
  } else {
    switch ($$event.TAG) {
      case "CreateConversation" :
          return "create_conversation";
      case "AddMessage" :
          return "add_message";
      case "SearchMessages" :
          return "search_messages";
      
    }
  }
}

var $$Event = {
  toString: toString$1
};

function isValid(transition) {
  var match = transition.from;
  var match$1 = transition.event;
  var match$2 = transition.to;
  switch (match) {
    case "Idle" :
        if (typeof match$1 !== "object" || !(match$1.TAG === "CreateConversation" && match$2 === "Active")) {
          return false;
        } else {
          return true;
        }
    case "Active" :
        if (typeof match$1 !== "object") {
          switch (match$1) {
            case "ArchiveConversation" :
                if (match$2 === "Archived") {
                  return true;
                } else {
                  return false;
                }
            case "DeleteConversation" :
                if (match$2 === "Deleted") {
                  return true;
                } else {
                  return false;
                }
            case "RestoreConversation" :
                return false;
            
          }
        } else {
          switch (match$1.TAG) {
            case "CreateConversation" :
                return false;
            case "AddMessage" :
                if (match$2 === "Active") {
                  return true;
                } else {
                  return false;
                }
            case "SearchMessages" :
                if (match$2 === "Searching") {
                  return true;
                } else {
                  return false;
                }
            
          }
        }
    case "Searching" :
        if (typeof match$1 !== "object") {
          switch (match$1) {
            case "ArchiveConversation" :
                if (match$2 === "Archived") {
                  return true;
                } else {
                  return false;
                }
            case "DeleteConversation" :
                if (match$2 === "Deleted") {
                  return true;
                } else {
                  return false;
                }
            case "RestoreConversation" :
                return false;
            
          }
        } else {
          switch (match$1.TAG) {
            case "CreateConversation" :
                return false;
            case "AddMessage" :
                if (match$2 === "Active") {
                  return true;
                } else {
                  return false;
                }
            case "SearchMessages" :
                if (match$2 === "Searching") {
                  return true;
                } else {
                  return false;
                }
            
          }
        }
    case "Archived" :
        if (typeof match$1 === "object") {
          if (match$1.TAG === "SearchMessages" && match$2 === "Searching") {
            return true;
          } else {
            return false;
          }
        }
        switch (match$1) {
          case "DeleteConversation" :
              if (match$2 === "Deleted") {
                return true;
              } else {
                return false;
              }
          case "RestoreConversation" :
              if (match$2 === "Active") {
                return true;
              } else {
                return false;
              }
          default:
            return false;
        }
    case "Deleted" :
        if (typeof match$1 !== "object" && match$1 === "RestoreConversation" && match$2 === "Active") {
          return true;
        } else {
          return false;
        }
    
  }
}

function make(from, $$event, to) {
  var transition = {
    from: from,
    event: $$event,
    to: to
  };
  if (isValid(transition)) {
    return transition;
  }
  
}

var Transition = {
  isValid: isValid,
  make: make
};

function make$1(conversationId, agentId, userId) {
  var now = Date.now();
  return {
          conversationId: conversationId,
          agentId: agentId,
          userId: userId,
          messageCount: 0,
          totalTokens: 0,
          createdAt: now,
          updatedAt: now,
          metadata: {},
          history: []
        };
}

function incrementMessageCount(context) {
  return {
          conversationId: context.conversationId,
          agentId: context.agentId,
          userId: context.userId,
          messageCount: context.messageCount + 1 | 0,
          totalTokens: context.totalTokens,
          createdAt: context.createdAt,
          updatedAt: Date.now(),
          metadata: context.metadata,
          history: context.history
        };
}

function addTokens(context, tokens) {
  return {
          conversationId: context.conversationId,
          agentId: context.agentId,
          userId: context.userId,
          messageCount: context.messageCount,
          totalTokens: context.totalTokens + tokens | 0,
          createdAt: context.createdAt,
          updatedAt: Date.now(),
          metadata: context.metadata,
          history: context.history
        };
}

function setMetadata(context, key, value) {
  var newMetadata = Js_dict.fromArray(Js_dict.entries(context.metadata));
  newMetadata[key] = value;
  return {
          conversationId: context.conversationId,
          agentId: context.agentId,
          userId: context.userId,
          messageCount: context.messageCount,
          totalTokens: context.totalTokens,
          createdAt: context.createdAt,
          updatedAt: Date.now(),
          metadata: newMetadata,
          history: context.history
        };
}

function addToHistory(context, state) {
  return {
          conversationId: context.conversationId,
          agentId: context.agentId,
          userId: context.userId,
          messageCount: context.messageCount,
          totalTokens: context.totalTokens,
          createdAt: context.createdAt,
          updatedAt: context.updatedAt,
          metadata: context.metadata,
          history: context.history.concat([state])
        };
}

function update(context) {
  return {
          conversationId: context.conversationId,
          agentId: context.agentId,
          userId: context.userId,
          messageCount: context.messageCount,
          totalTokens: context.totalTokens,
          createdAt: context.createdAt,
          updatedAt: Date.now(),
          metadata: context.metadata,
          history: context.history
        };
}

var Context = {
  make: make$1,
  incrementMessageCount: incrementMessageCount,
  addTokens: addTokens,
  setMetadata: setMetadata,
  addToHistory: addToHistory,
  update: update
};

function make$2(conversationId, agentId, userId) {
  return {
          currentState: "Idle",
          context: make$1(conversationId, agentId, userId)
        };
}

function transition(machine, $$event, targetState) {
  var trans_from = machine.currentState;
  var match = make(trans_from, $$event, targetState);
  if (match !== undefined) {
    var newContext = addToHistory(machine.context, machine.currentState);
    return {
            TAG: "Ok",
            _0: {
              currentState: targetState,
              context: update(newContext)
            }
          };
  }
  var from = toString(machine.currentState);
  var to = toString(targetState);
  var evt = toString$1($$event);
  return {
          TAG: "Error",
          _0: "Invalid memory transition: " + from + " -[" + evt + "]-> " + to
        };
}

function getCurrentState(machine) {
  return machine.currentState;
}

function getContext(machine) {
  return machine.context;
}

function updateContext(machine, updater) {
  return {
          currentState: machine.currentState,
          context: updater(machine.context)
        };
}

function canTransition(machine, $$event, targetState) {
  var trans_from = machine.currentState;
  var trans = {
    from: trans_from,
    event: $$event,
    to: targetState
  };
  return isValid(trans);
}

var Machine = {
  make: make$2,
  transition: transition,
  getCurrentState: getCurrentState,
  getContext: getContext,
  updateContext: updateContext,
  canTransition: canTransition
};

function make$3(conversationId, agentId, userId) {
  return make$2(conversationId, agentId, userId);
}

function makeSimple(conversationId, agentId) {
  return make$2(conversationId, agentId, undefined);
}

function transition$1(machine, eventType, eventData, targetState) {
  var targetStateOpt = fromString(targetState);
  if (targetStateOpt === undefined) {
    return {
            TAG: "Error",
            _0: "Invalid target state: " + targetState
          };
  }
  var eventOpt;
  switch (eventType) {
    case "add_message" :
        var obj = Js_json.decodeObject(eventData);
        if (obj !== undefined) {
          var role = Belt_Option.flatMap(Js_dict.get(obj, "role"), Js_json.decodeString);
          var content = Belt_Option.flatMap(Js_dict.get(obj, "content"), Js_json.decodeString);
          var tokens = Belt_Option.map(Belt_Option.flatMap(Js_dict.get(obj, "tokens"), Js_json.decodeNumber), (function (prim) {
                  return prim | 0;
                }));
          eventOpt = role !== undefined && content !== undefined ? ({
                TAG: "AddMessage",
                _0: {
                  role: role,
                  content: content,
                  tokens: tokens
                }
              }) : undefined;
        } else {
          eventOpt = undefined;
        }
        break;
    case "archive_conversation" :
        eventOpt = "ArchiveConversation";
        break;
    case "create_conversation" :
        var obj$1 = Js_json.decodeObject(eventData);
        if (obj$1 !== undefined) {
          var agentId = Belt_Option.flatMap(Js_dict.get(obj$1, "agentId"), Js_json.decodeString);
          var title = Belt_Option.flatMap(Js_dict.get(obj$1, "title"), Js_json.decodeString);
          var userId = Belt_Option.flatMap(Js_dict.get(obj$1, "userId"), Js_json.decodeString);
          eventOpt = agentId !== undefined && title !== undefined ? ({
                TAG: "CreateConversation",
                _0: {
                  agentId: agentId,
                  title: title,
                  userId: userId
                }
              }) : undefined;
        } else {
          eventOpt = undefined;
        }
        break;
    case "delete_conversation" :
        eventOpt = "DeleteConversation";
        break;
    case "restore_conversation" :
        eventOpt = "RestoreConversation";
        break;
    case "search_messages" :
        var obj$2 = Js_json.decodeObject(eventData);
        if (obj$2 !== undefined) {
          var query = Belt_Option.flatMap(Js_dict.get(obj$2, "query"), Js_json.decodeString);
          eventOpt = query !== undefined ? ({
                TAG: "SearchMessages",
                _0: {
                  query: query
                }
              }) : undefined;
        } else {
          eventOpt = undefined;
        }
        break;
    default:
      eventOpt = undefined;
  }
  if (eventOpt !== undefined) {
    return transition(machine, eventOpt, targetStateOpt);
  } else {
    return {
            TAG: "Error",
            _0: "Invalid event type: " + eventType
          };
  }
}

function getCurrentState$1(machine) {
  return toString(machine.currentState);
}

function getMessageCount(machine) {
  return machine.context.messageCount;
}

function getTotalTokens(machine) {
  return machine.context.totalTokens;
}

function getConversationId(machine) {
  return machine.context.conversationId;
}

function getAgentId(machine) {
  return machine.context.agentId;
}

function getUserId(machine) {
  return machine.context.userId;
}

function incrementMessageCount$1(machine) {
  return updateContext(machine, incrementMessageCount);
}

function addTokens$1(machine, tokens) {
  return updateContext(machine, (function (context) {
                return addTokens(context, tokens);
              }));
}

function setMetadata$1(machine, key, value) {
  return updateContext(machine, (function (context) {
                return setMetadata(context, key, value);
              }));
}

function canTransition$1(machine, eventType, targetState) {
  var targetStateOpt = fromString(targetState);
  var eventOpt;
  switch (eventType) {
    case "add_message" :
        eventOpt = {
          TAG: "AddMessage",
          _0: {
            role: "",
            content: "",
            tokens: undefined
          }
        };
        break;
    case "archive_conversation" :
        eventOpt = "ArchiveConversation";
        break;
    case "create_conversation" :
        eventOpt = {
          TAG: "CreateConversation",
          _0: {
            agentId: "",
            title: "",
            userId: undefined
          }
        };
        break;
    case "delete_conversation" :
        eventOpt = "DeleteConversation";
        break;
    case "restore_conversation" :
        eventOpt = "RestoreConversation";
        break;
    case "search_messages" :
        eventOpt = {
          TAG: "SearchMessages",
          _0: {
            query: ""
          }
        };
        break;
    default:
      eventOpt = undefined;
  }
  if (eventOpt !== undefined && targetStateOpt !== undefined) {
    return canTransition(machine, eventOpt, targetStateOpt);
  } else {
    return false;
  }
}

function getHistory(machine) {
  var history = machine.context.history;
  return history.map(toString);
}

export {
  State ,
  $$Event ,
  Transition ,
  Context ,
  Machine ,
  make$3 as make,
  makeSimple ,
  transition$1 as transition,
  getCurrentState$1 as getCurrentState,
  getMessageCount ,
  getTotalTokens ,
  getConversationId ,
  getAgentId ,
  getUserId ,
  incrementMessageCount$1 as incrementMessageCount,
  addTokens$1 as addTokens,
  setMetadata$1 as setMetadata,
  canTransition$1 as canTransition,
  getHistory ,
}
/* No side effect */
