name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback (e.g., 5.6.6)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      skip_npm:
        description: 'Skip npm unpublish (if already done manually)'
        required: false
        type: boolean
        default: false
      skip_github:
        description: 'Skip GitHub Release deletion (if you want to keep it)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  rollback:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: ${{ !inputs.skip_npm }}
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Confirm rollback
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  WARNING: ROLLBACK INITIATED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Version: ${{ inputs.version }}"
          echo "ğŸ“ Reason: ${{ inputs.reason }}"
          echo ""
          echo "Actions to perform:"
          if [[ "${{ inputs.skip_npm }}" != "true" ]]; then
            echo "  âŒ Unpublish from npm: @defai.digital/automatosx@${{ inputs.version }}"
          else
            echo "  â­ï¸  Skip npm unpublish"
          fi
          if [[ "${{ inputs.skip_github }}" != "true" ]]; then
            echo "  âŒ Delete GitHub Release: v${{ inputs.version }}"
          else
            echo "  â­ï¸  Skip GitHub Release deletion"
          fi
          echo ""
          echo "â³ Waiting 10 seconds... Press 'Cancel workflow' to abort."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sleep 10

      - name: Verify version exists on npm
        if: ${{ !inputs.skip_npm }}
        run: |
          echo "ğŸ” Verifying version ${{ inputs.version }} exists on npm..."

          if npm view @defai.digital/automatosx@${{ inputs.version }} version > /dev/null 2>&1; then
            echo "âœ… Version ${{ inputs.version }} found on npm"
          else
            echo "âŒ Version ${{ inputs.version }} not found on npm"
            echo "ğŸ’¡ Tip: Use --skip_npm=true if you already unpublished manually"
            exit 1
          fi

      - name: Unpublish from npm
        if: ${{ !inputs.skip_npm }}
        run: |
          echo "ğŸ“¤ Unpublishing @defai.digital/automatosx@${{ inputs.version }} from npm..."

          # npm unpublish requires --force flag
          npm unpublish @defai.digital/automatosx@${{ inputs.version }} --force

          echo "âœ… Successfully unpublished from npm"

          # Wait for npm to propagate
          echo "â³ Waiting 30 seconds for npm to propagate..."
          sleep 30

          # Verify unpublish
          if npm view @defai.digital/automatosx@${{ inputs.version }} version > /dev/null 2>&1; then
            echo "âš ï¸  WARNING: Version still visible on npm (may take a few minutes)"
          else
            echo "âœ… Version no longer visible on npm"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Delete GitHub Release
        if: ${{ !inputs.skip_github }}
        run: |
          echo "ğŸ—‘ï¸  Deleting GitHub Release v${{ inputs.version }}..."

          if gh release view v${{ inputs.version }} > /dev/null 2>&1; then
            gh release delete v${{ inputs.version }} --yes --cleanup-tag
            echo "âœ… GitHub Release deleted"
          else
            echo "âš ï¸  GitHub Release v${{ inputs.version }} not found (may have been deleted already)"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create rollback issue
        run: |
          echo "ğŸ“ Creating rollback tracking issue..."

          ISSUE_BODY=$(cat <<'EOF'
## ğŸ”„ Rollback: v${{ inputs.version }}

**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Reason**: ${{ inputs.reason }}
**Triggered by**: @${{ github.actor }}

### Actions Performed

${{ inputs.skip_npm == false && '- âŒ Unpublished from npm: @defai.digital/automatosx@${{ inputs.version }}' || '- â­ï¸  Skipped npm unpublish' }}
${{ inputs.skip_github == false && '- âŒ Deleted GitHub Release: v${{ inputs.version }}' || '- â­ï¸  Skipped GitHub Release deletion' }}

### Recommended Next Steps

1. **Investigate root cause** of the issue that triggered rollback
2. **Fix the issue** in a new branch
3. **Run full test suite** to verify the fix
4. **Release new version** (v${{ inputs.version }}+1 or patch version)

### Timeline

- **Rollback initiated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
- **Target fix date**: _To be determined_

### Related Links

- **Rollback workflow**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
- **Original release**: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }} (if not deleted)

---

**âš ï¸ IMPORTANT**: Users who installed v${{ inputs.version }} should upgrade to the next stable version once available.
EOF
          )

          gh issue create \
            --title "ğŸ”„ Rollback: v${{ inputs.version }} - ${{ inputs.reason }}" \
            --body "$ISSUE_BODY" \
            --label "rollback,urgent" \
            --assignee "${{ github.actor }}"

          echo "âœ… Rollback tracking issue created"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rollback summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Rollback Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Version: ${{ inputs.version }}"
          echo "ğŸ“ Reason: ${{ inputs.reason }}"
          echo ""

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… Rollback completed successfully"
            echo ""
            echo "Actions taken:"
            if [[ "${{ inputs.skip_npm }}" != "true" ]]; then
              echo "  âœ… Unpublished from npm"
            fi
            if [[ "${{ inputs.skip_github }}" != "true" ]]; then
              echo "  âœ… Deleted GitHub Release"
            fi
            echo "  âœ… Created tracking issue"
          else
            echo "âŒ Rollback failed"
            echo ""
            echo "âš ï¸  Some steps may have completed successfully."
            echo "âš ï¸  Check the workflow logs for details."
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Notify failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Rollback failed for version ${{ inputs.version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the workflow logs for details."
          echo ""
          echo "Common issues:"
          echo "  - NPM_TOKEN secret not configured or expired"
          echo "  - Version already unpublished from npm"
          echo "  - GitHub Release already deleted"
          echo "  - Insufficient permissions"
          echo ""
          echo "ğŸ’¡ Tip: You can use --skip_npm or --skip_github flags"
          echo "        to skip steps that are already done."
          echo ""
