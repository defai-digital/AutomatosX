// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Belt_MapString from "rescript/lib/es6/belt_MapString.js";

function getCurrentTime() {
  return Date.now();
}

function generateId(prefix) {
  var timestamp = Date.now();
  var random = Math.random();
  return prefix + "-" + String(timestamp) + "-" + String(random);
}

function matchesPattern(eventType, pattern) {
  if (eventType === pattern) {
    return true;
  }
  if (pattern === "*") {
    return true;
  }
  if (!pattern.endsWith("*")) {
    return false;
  }
  var prefix = pattern.slice(0, pattern.length - 1 | 0);
  return eventType.startsWith(prefix);
}

function getMatchingSubscriptions(bus, eventType) {
  return Belt_Array.reverse(Belt_Array.keep(Belt_MapString.valuesToArray(bus.subscriptions), (function (sub) {
                      if (sub.active) {
                        return matchesPattern(eventType, sub.pattern);
                      } else {
                        return false;
                      }
                    }))).toSorted(function (a, b) {
              if (b.priority > a.priority) {
                return 1.0;
              } else if (b.priority < a.priority) {
                return -1.0;
              } else {
                return 0.0;
              }
            });
}

function applyEventFilter(events, filter) {
  var filtered = Belt_Array.keep(events, (function ($$event) {
          var t = filter.eventType;
          var typeMatch = t !== undefined ? $$event.eventType === t : true;
          var s = filter.source;
          var sourceMatch;
          if (s !== undefined) {
            var eventSource = $$event.source;
            sourceMatch = eventSource !== undefined ? eventSource === s : false;
          } else {
            sourceMatch = true;
          }
          var start = filter.startTime;
          var afterStart = start !== undefined ? $$event.timestamp >= start : true;
          var end_ = filter.endTime;
          var beforeEnd = end_ !== undefined ? $$event.timestamp <= end_ : true;
          var timeMatch = afterStart && beforeEnd;
          if (typeMatch && sourceMatch) {
            return timeMatch;
          } else {
            return false;
          }
        }));
  var limit = filter.limit;
  if (limit !== undefined) {
    return Belt_Array.slice(filtered, 0, limit);
  } else {
    return filtered;
  }
}

function createConfig(maxHistorySizeOpt, enableHistoryOpt, enableFilteringOpt, defaultPriorityOpt, param) {
  var maxHistorySize = maxHistorySizeOpt !== undefined ? maxHistorySizeOpt : 1000;
  var enableHistory = enableHistoryOpt !== undefined ? enableHistoryOpt : true;
  var enableFiltering = enableFilteringOpt !== undefined ? enableFilteringOpt : true;
  var defaultPriority = defaultPriorityOpt !== undefined ? defaultPriorityOpt : 0;
  return {
          maxHistorySize: maxHistorySize,
          enableHistory: enableHistory,
          enableFiltering: enableFiltering,
          defaultPriority: defaultPriority
        };
}

function create(config, param) {
  var defaultConfig = createConfig(undefined, undefined, undefined, undefined, undefined);
  var finalConfig = config !== undefined ? config : defaultConfig;
  return {
          subscriptions: undefined,
          history: [],
          config: finalConfig,
          eventCount: 0,
          errorCount: 0
        };
}

function subscribe(bus, pattern, handler, priority, param) {
  var id = generateId("sub");
  var finalPriority = priority !== undefined ? priority : bus.config.defaultPriority;
  var subscription_createdAt = Date.now();
  var subscription = {
    id: id,
    pattern: pattern,
    handler: handler,
    priority: finalPriority,
    active: true,
    createdAt: subscription_createdAt
  };
  var newSubscriptions = Belt_MapString.set(bus.subscriptions, id, subscription);
  var newBus = {
    subscriptions: newSubscriptions,
    history: bus.history,
    config: bus.config,
    eventCount: bus.eventCount,
    errorCount: bus.errorCount
  };
  return {
          TAG: "Ok",
          _0: [
            newBus,
            id
          ]
        };
}

function unsubscribe(bus, subscriberId) {
  var match = Belt_MapString.get(bus.subscriptions, subscriberId);
  if (match === undefined) {
    return {
            TAG: "Error",
            _0: "Subscriber not found: " + subscriberId
          };
  }
  var newSubscriptions = Belt_MapString.remove(bus.subscriptions, subscriberId);
  return {
          TAG: "Ok",
          _0: {
            subscriptions: newSubscriptions,
            history: bus.history,
            config: bus.config,
            eventCount: bus.eventCount,
            errorCount: bus.errorCount
          }
        };
}

function pauseSubscription(bus, subscriberId) {
  var sub = Belt_MapString.get(bus.subscriptions, subscriberId);
  if (sub === undefined) {
    return {
            TAG: "Error",
            _0: "Subscriber not found: " + subscriberId
          };
  }
  var updatedSub_id = sub.id;
  var updatedSub_pattern = sub.pattern;
  var updatedSub_handler = sub.handler;
  var updatedSub_priority = sub.priority;
  var updatedSub_createdAt = sub.createdAt;
  var updatedSub = {
    id: updatedSub_id,
    pattern: updatedSub_pattern,
    handler: updatedSub_handler,
    priority: updatedSub_priority,
    active: false,
    createdAt: updatedSub_createdAt
  };
  var newSubscriptions = Belt_MapString.set(bus.subscriptions, subscriberId, updatedSub);
  return {
          TAG: "Ok",
          _0: {
            subscriptions: newSubscriptions,
            history: bus.history,
            config: bus.config,
            eventCount: bus.eventCount,
            errorCount: bus.errorCount
          }
        };
}

function resumeSubscription(bus, subscriberId) {
  var sub = Belt_MapString.get(bus.subscriptions, subscriberId);
  if (sub === undefined) {
    return {
            TAG: "Error",
            _0: "Subscriber not found: " + subscriberId
          };
  }
  var updatedSub_id = sub.id;
  var updatedSub_pattern = sub.pattern;
  var updatedSub_handler = sub.handler;
  var updatedSub_priority = sub.priority;
  var updatedSub_createdAt = sub.createdAt;
  var updatedSub = {
    id: updatedSub_id,
    pattern: updatedSub_pattern,
    handler: updatedSub_handler,
    priority: updatedSub_priority,
    active: true,
    createdAt: updatedSub_createdAt
  };
  var newSubscriptions = Belt_MapString.set(bus.subscriptions, subscriberId, updatedSub);
  return {
          TAG: "Ok",
          _0: {
            subscriptions: newSubscriptions,
            history: bus.history,
            config: bus.config,
            eventCount: bus.eventCount,
            errorCount: bus.errorCount
          }
        };
}

function getSubscription(bus, subscriberId) {
  return Belt_MapString.get(bus.subscriptions, subscriberId);
}

function getAllSubscriptions(bus) {
  return Belt_MapString.valuesToArray(bus.subscriptions);
}

function getActiveSubscriptions(bus) {
  return Belt_Array.keep(Belt_MapString.valuesToArray(bus.subscriptions), (function (sub) {
                return sub.active;
              }));
}

function createEvent(eventType, payload, source, metadata, priority, param) {
  return {
          id: generateId("event"),
          eventType: eventType,
          payload: payload,
          timestamp: Date.now(),
          source: source,
          metadata: metadata,
          priority: priority !== undefined ? priority : 0
        };
}

async function publish(bus, $$event) {
  var subscribers = getMatchingSubscriptions(bus, $$event.eventType);
  if (bus.config.enableFiltering && subscribers.length === 0) {
    var newBus;
    if (bus.config.enableHistory) {
      var newHistory = Belt_Array.concat(bus.history, [$$event]);
      var trimmedHistory = newHistory.length > bus.config.maxHistorySize ? Belt_Array.sliceToEnd(newHistory, newHistory.length - bus.config.maxHistorySize | 0) : newHistory;
      newBus = {
        subscriptions: bus.subscriptions,
        history: trimmedHistory,
        config: bus.config,
        eventCount: bus.eventCount + 1 | 0,
        errorCount: bus.errorCount
      };
    } else {
      newBus = {
        subscriptions: bus.subscriptions,
        history: bus.history,
        config: bus.config,
        eventCount: bus.eventCount + 1 | 0,
        errorCount: bus.errorCount
      };
    }
    return Promise.resolve({
                TAG: "Ok",
                _0: newBus
              });
  }
  var handlerPromises = Belt_Array.map(subscribers, (function (sub) {
          return sub.handler($$event);
        }));
  var results = await Promise.all(handlerPromises);
  var errors = Belt_Array.keep(results, (function (r) {
          if (r.TAG === "Ok") {
            return false;
          } else {
            return true;
          }
        }));
  var errorCount = errors.length;
  var newHistory$1;
  if (bus.config.enableHistory) {
    var newHist = Belt_Array.concat(bus.history, [$$event]);
    newHistory$1 = newHist.length > bus.config.maxHistorySize ? Belt_Array.sliceToEnd(newHist, newHist.length - bus.config.maxHistorySize | 0) : newHist;
  } else {
    newHistory$1 = bus.history;
  }
  var newBus$1 = {
    subscriptions: bus.subscriptions,
    history: newHistory$1,
    config: bus.config,
    eventCount: bus.eventCount + 1 | 0,
    errorCount: bus.errorCount + errorCount | 0
  };
  return Promise.resolve({
              TAG: "Ok",
              _0: newBus$1
            });
}

function publishSync(bus, $$event) {
  var subscribers = getMatchingSubscriptions(bus, $$event.eventType);
  var newHistory;
  if (bus.config.enableHistory) {
    var newHist = Belt_Array.concat(bus.history, [$$event]);
    newHistory = newHist.length > bus.config.maxHistorySize ? Belt_Array.sliceToEnd(newHist, newHist.length - bus.config.maxHistorySize | 0) : newHist;
  } else {
    newHistory = bus.history;
  }
  var newBus = {
    subscriptions: bus.subscriptions,
    history: newHistory,
    config: bus.config,
    eventCount: bus.eventCount + 1 | 0,
    errorCount: bus.errorCount
  };
  Belt_Array.forEach(subscribers, (function (sub) {
          sub.handler($$event);
        }));
  return {
          TAG: "Ok",
          _0: newBus
        };
}

function getHistory(bus, filter, param) {
  if (filter !== undefined) {
    return applyEventFilter(bus.history, filter);
  } else {
    return bus.history;
  }
}

function clearHistory(bus) {
  return {
          subscriptions: bus.subscriptions,
          history: [],
          config: bus.config,
          eventCount: bus.eventCount,
          errorCount: bus.errorCount
        };
}

function getEvent(bus, eventId) {
  return Belt_Array.getBy(bus.history, (function ($$event) {
                return $$event.id === eventId;
              }));
}

function getEventsByType(bus, eventType, limit, param) {
  var filtered = Belt_Array.keep(bus.history, (function ($$event) {
          return $$event.eventType === eventType;
        }));
  if (limit !== undefined) {
    return Belt_Array.slice(filtered, 0, limit);
  } else {
    return filtered;
  }
}

function getEventsBySource(bus, source, limit, param) {
  var filtered = Belt_Array.keep(bus.history, (function ($$event) {
          var s = $$event.source;
          if (s !== undefined) {
            return s === source;
          } else {
            return false;
          }
        }));
  if (limit !== undefined) {
    return Belt_Array.slice(filtered, 0, limit);
  } else {
    return filtered;
  }
}

function getRecentEvents(bus, count) {
  var historyLen = bus.history.length;
  if (historyLen <= count) {
    return bus.history;
  } else {
    return Belt_Array.sliceToEnd(bus.history, historyLen - count | 0);
  }
}

function getStats(bus) {
  var allSubs = Belt_MapString.valuesToArray(bus.subscriptions);
  var activeSubs = Belt_Array.keep(allSubs, (function (sub) {
          return sub.active;
        }));
  var avgHandlers = bus.eventCount === 0 ? 0.0 : allSubs.length / bus.eventCount;
  return {
          totalEvents: bus.eventCount,
          totalSubscribers: allSubs.length,
          activeSubscribers: activeSubs.length,
          historySize: bus.history.length,
          errorCount: bus.errorCount,
          averageHandlers: avgHandlers
        };
}

function hasSubscribers(bus, pattern) {
  var matching = getMatchingSubscriptions(bus, pattern);
  return matching.length !== 0;
}

function getSubscriberCount(bus, pattern) {
  return getMatchingSubscriptions(bus, pattern).length;
}

function reset(bus) {
  return {
          subscriptions: undefined,
          history: [],
          config: bus.config,
          eventCount: 0,
          errorCount: 0
        };
}

function createFilter(eventType, source, startTime, endTime, limit, param) {
  return {
          eventType: eventType,
          source: source,
          startTime: startTime,
          endTime: endTime,
          limit: limit
        };
}

export {
  getCurrentTime ,
  generateId ,
  matchesPattern ,
  getMatchingSubscriptions ,
  applyEventFilter ,
  createConfig ,
  create ,
  subscribe ,
  unsubscribe ,
  pauseSubscription ,
  resumeSubscription ,
  getSubscription ,
  getAllSubscriptions ,
  getActiveSubscriptions ,
  createEvent ,
  publish ,
  publishSync ,
  getHistory ,
  clearHistory ,
  getEvent ,
  getEventsByType ,
  getEventsBySource ,
  getRecentEvents ,
  getStats ,
  hasSubscribers ,
  getSubscriberCount ,
  reset ,
  createFilter ,
}
/* No side effect */
