// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as StateMachine from "../runtime/StateMachine.bs.js";

function createTraceContext(traceId, spanId, timestamp) {
  return {
          traceId: traceId,
          spanId: spanId,
          timestamp: timestamp
        };
}

function createAuthenticatedEvent($$event, traceContext, nonce, signature, param) {
  return {
          event: $$event,
          traceContext: traceContext,
          nonce: nonce,
          signature: signature
        };
}

function createNonceState(maxHistorySizeOpt, param) {
  var maxHistorySize = maxHistorySizeOpt !== undefined ? maxHistorySizeOpt : 1000;
  return {
          lastNonce: 0,
          processedNonces: [],
          maxHistorySize: maxHistorySize
        };
}

function attachTraceContext(_event, generateUuid) {
  var traceId = generateUuid();
  var spanId = generateUuid();
  var timestamp = Date.now();
  return {
          traceId: traceId,
          spanId: spanId,
          timestamp: timestamp
        };
}

function checkNonce(state, nonce) {
  if (Belt_Array.some(state.processedNonces, (function (n) {
            return n === nonce;
          }))) {
    return {
            TAG: "Replay",
            _0: "Nonce " + String(nonce) + " already processed"
          };
  } else if (nonce <= state.lastNonce) {
    return {
            TAG: "InvalidNonce",
            _0: "Nonce " + String(nonce) + " is not greater than last nonce " + String(state.lastNonce)
          };
  } else {
    return "Fresh";
  }
}

function recordNonce(state, nonce) {
  state.processedNonces = Belt_Array.concat(state.processedNonces, [nonce]);
  if (state.processedNonces.length > state.maxHistorySize) {
    state.processedNonces = Belt_Array.sliceToEnd(state.processedNonces, state.processedNonces.length - state.maxHistorySize | 0);
  }
  state.lastNonce = nonce;
}

function verifyEvent(authEvent, nonceState) {
  var msg = checkNonce(nonceState, authEvent.nonce);
  if (typeof msg === "object") {
    if (msg.TAG === "Replay") {
      return {
              TAG: "Error",
              _0: "Replay attack detected: " + msg._0
            };
    } else {
      return {
              TAG: "Error",
              _0: "Invalid nonce: " + msg._0
            };
    }
  }
  recordNonce(nonceState, authEvent.nonce);
  return {
          TAG: "Ok",
          _0: authEvent
        };
}

function authenticateEvent($$event, nonce, generateUuid) {
  var traceContext = attachTraceContext($$event, generateUuid);
  return createAuthenticatedEvent($$event, traceContext, nonce, undefined, undefined);
}

function traceContextToString(ctx) {
  return "TraceID=" + ctx.traceId + ", SpanID=" + ctx.spanId + ", Timestamp=" + String(ctx.timestamp);
}

function authenticatedEventToString(authEvent) {
  var eventStr = StateMachine.$$Event.toString(authEvent.event);
  var traceStr = traceContextToString(authEvent.traceContext);
  var nonceStr = String(authEvent.nonce);
  return "Event=" + eventStr + ", " + traceStr + ", Nonce=" + nonceStr;
}

function replayResultToString(result) {
  if (typeof result !== "object") {
    return "Fresh";
  } else if (result.TAG === "Replay") {
    return "Replay(" + result._0 + ")";
  } else {
    return "InvalidNonce(" + result._0 + ")";
  }
}

function isFresh(result) {
  if (typeof result !== "object") {
    return true;
  } else {
    return false;
  }
}

function getNonceHistoryCount(state) {
  return state.processedNonces.length;
}

function getLastNonce(state) {
  return state.lastNonce;
}

function clearNonceHistory(state) {
  state.processedNonces = [];
  state.lastNonce = 0;
}

export {
  createTraceContext ,
  createAuthenticatedEvent ,
  createNonceState ,
  attachTraceContext ,
  checkNonce ,
  recordNonce ,
  verifyEvent ,
  authenticateEvent ,
  traceContextToString ,
  authenticatedEventToString ,
  replayResultToString ,
  isFresh ,
  getNonceHistoryCount ,
  getLastNonce ,
  clearNonceHistory ,
}
/* No side effect */
